<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MultiRig Settings</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="data:,">
</head>
<body>
  <header class="topbar">
    <div class="brand">MultiRig</div>
    <nav>
      <a href="/">Dashboard</a>
      <button id="darkToggle" title="Toggle dark mode">ðŸŒ“</button>
    </nav>
  </header>

  <main class="container">
    <h2>Configuration</h2>
    <form id="cfgForm" class="form-grid">
      <fieldset>
        <legend>Rigs</legend>
        <div id="rigList"></div>
        <div class="actions">
          <button type="button" id="addRig">Add Rig</button>
        </div>
      </fieldset>
      <fieldset>
        <legend>Sync</legend>
        <label>Poll interval (ms) <input type="number" min="100" step="50" name="poll" value="{{ config.poll_interval_ms }}"></label>
      </fieldset>
      <div class="actions">
        <button type="submit">Save</button>
        <span id="saveResult"></span>
      </div>
    </form>

    <section class="help">
      <h3>Hamlib Quick Start</h3>
      <ul>
        <li>Install hamlib and start a rigctld instance for each rig you want to control.</li>
        <li>Example (QCX+ over USB serial):<br>
          <code>rigctld -m 3073 -r /dev/ttyUSB0 -s 38400 -t 4532</code>
        </li>
        <li>Example (second rig on another port):<br>
          <code>rigctld -m 3073 -r /dev/ttyUSB1 -s 38400 -t 4533</code>
        </li>
        <li>XIEGU XPA125B: control may be via CAT pass-through from the rig; for direct control use hamlib ampctl on its port and consider future integration.</li>
        <li>WSJT-X can connect to Rig A's rigctld; this app mirrors frequency/mode to Rig B.</li>
      </ul>
    </section>
  </main>

  <script>
    // Dark mode
    (function(){
      const btn = document.getElementById('darkToggle');
      if(btn){ btn.onclick = ()=>{
        const t = document.documentElement.dataset.theme === 'dark' ? '' : 'dark';
        document.documentElement.dataset.theme = t;
        localStorage.setItem('theme', t);
      };}
      const t = localStorage.getItem('theme'); if(t) document.documentElement.dataset.theme = t;
    })();

    const form = document.getElementById('cfgForm');
    const rigList = document.getElementById('rigList');
    const addRigBtn = document.getElementById('addRig');

    let rigs = [];

    function render() {
      rigList.innerHTML = '';
      rigs.forEach((rig, idx) => {
        const fs = document.createElement('fieldset');
        fs.innerHTML = `
          <legend>${rig.name || `Rig ${idx+1}`}</legend>
          <label>Name <input type="text" data-key="name" value="${rig.name || ''}"></label>
          <label>Connection
            <select data-key="connection_type">
              <option value="rigctld">rigctld (TCP)</option>
              <option value="hamlib">hamlib (direct rigctl)</option>
            </select>
          </label>
          <div class="conn rigctld">
            <label>Host <input type="text" data-key="host" value="${rig.host || '127.0.0.1'}"></label>
            <label>Port <input type="number" data-key="port" value="${rig.port ?? 4532}"></label>
          </div>
          <div class="conn hamlib">
            <label>Model ID (-m) <input type="number" data-key="model_id" value="${rig.model_id ?? ''}" placeholder="e.g., 3073"></label>
            <label>Device (-r) <input type="text" data-key="device" value="${rig.device ?? ''}" placeholder="/dev/ttyUSB0 or /dev/cu.usbserial"></label>
            <label>Baud (-s) <input type="number" data-key="baud" value="${rig.baud ?? ''}" placeholder="38400"></label>
            <label>Serial opts <input type="text" data-key="serial_opts" value="${rig.serial_opts ?? ''}" placeholder="e.g., N8 RTSCTS"></label>
            <label>Extra args <input type="text" data-key="extra_args" value="${rig.extra_args ?? ''}" placeholder="additional rigctl flags"></label>
          </div>
          <div class="actions">
            <button type="button" data-action="remove">Remove</button>
          </div>
        `;
        // Initialize selects and visibility
        const sel = fs.querySelector('select[data-key="connection_type"]');
        sel.value = rig.connection_type || 'rigctld';
        const updateVis = () => {
          fs.querySelector('.conn.rigctld').style.display = sel.value === 'rigctld' ? '' : 'none';
          fs.querySelector('.conn.hamlib').style.display = sel.value === 'hamlib' ? '' : 'none';
        };
        sel.addEventListener('change', updateVis);
        updateVis();
        // Wire remove
        fs.querySelector('[data-action="remove"]').addEventListener('click', () => {
          rigs.splice(idx, 1);
          render();
        });
        rigList.appendChild(fs);
      });
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        const cfg = await res.json();
        rigs = Array.isArray(cfg.rigs) && cfg.rigs.length ? cfg.rigs : [];
        // Set poll interval
        form.querySelector('input[name="poll"]').value = cfg.poll_interval_ms ?? 750;
        if (!rigs.length) {
          rigs = [
            { name: 'Rig 1', connection_type: 'rigctld', host: '127.0.0.1', port: 4532 },
          ];
        }
        render();
      } catch {}
    }

    addRigBtn.addEventListener('click', () => {
      const nextIndex = rigs.length + 1;
      rigs.push({ name: `Rig ${nextIndex}`, connection_type: 'rigctld', host: '127.0.0.1', port: 4532 });
      render();
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // collect current values from DOM into rigs array
      const fsList = Array.from(rigList.querySelectorAll('fieldset'));
      const newRigs = fsList.map((fs) => {
        const get = (sel) => fs.querySelector(sel);
        const val = (sel) => (get(sel)?.value ?? '').trim();
        const asNum = (sel) => {
          const v = val(sel); return v === '' ? null : Number(v);
        };
        const ct = val('select[data-key="connection_type"]') || 'rigctld';
        return {
          name: val('input[data-key="name"]') || 'Rig',
          connection_type: ct,
          host: val('input[data-key="host"]') || '127.0.0.1',
          port: Number(val('input[data-key="port"]') || (4532)),
          model_id: asNum('input[data-key="model_id"]'),
          device: val('input[data-key="device"]') || null,
          baud: asNum('input[data-key="baud"]'),
          serial_opts: val('input[data-key="serial_opts"]') || null,
          extra_args: val('input[data-key="extra_args"]') || null,
        };
      });
      const poll = Number(form.querySelector('input[name="poll"]').value || 750);
      const body = { rigs: newRigs, poll_interval_ms: poll, sync_enabled: true, sync_source_index: 0 };
      const res = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body) });
      const json = await res.json();
      document.getElementById('saveResult').textContent = json.status === 'ok' ? 'Saved' : 'Failed';
    });

    loadConfig();
  </script>
</body>
</html>
